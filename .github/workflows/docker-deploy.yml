name: Docker Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: npm ci

      - name: Check for lint errors
        run: npm run lint:server
      
      - name: Log in to the Container registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: type=raw,value=latest,enable=true
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    needs: build-and-push
    strategy:
      matrix:
        runner-label: [blog, minecraft]
    runs-on: [self-hosted, "${{ matrix.runner-label }}"]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Deploy to Server
        run: |
          # Convert repository name to lowercase
          REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_TAG="ghcr.io/$REPO:latest"
          
          echo "Deploying $IMAGE_TAG..."

          # Login to GHCR
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Pre-clean to free space
          docker system prune -af || true

          # Pull latest image
          docker pull $IMAGE_TAG
          
          # Stop old container if exists
          # Force remove any container binding port 4000 to prevent conflicts
          docker ps -q --filter "publish=4000" | xargs -r docker rm -f || true
          docker stop hamlog || true
          docker rm hamlog || true
          
          # Run new container
          docker run -d \
            --name hamlog \
            --restart unless-stopped \
            -p 4000:4000 \
            -v ~/hamlog-data/data:/app/server/data \
            -v ~/hamlog-data/uploads:/app/server/uploads \
            -e PORT=4000 \
            -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
            -e ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }} \
            $IMAGE_TAG
          
          # Cleanup unused images
          docker image prune -f

      - name: Send Telegram Notification
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="‚úÖ *Deployment Successful!*
          
          New version is live on HamLog. üöÄ" \
          -d parse_mode="Markdown"

      - name: Send Failure Notification
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="‚ùå *Deployment Failed!*
          
          Please check GitHub Actions for details." \
          -d parse_mode="Markdown"